{% extends "postlogin/base/base.html" %}
{% load static %}
{% block title %}Profile{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'patients' %}">Patients</a></li>
<li class="breadcrumb-item active" aria-current="page">Add Patient</li>
{% endblock %}

{% block main_content %}
<div class="">
    <form action="" method="POST" id="edit-profile-form" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        <div class="shadow-sm">
            <div class="">
                <div class="card shadow-sm mt-3">
                    <div class="card-body">
                        <h5 class="font-weight-bold">Personal Information</h5>
                        <div class="row form-group">
                            <div class="col-md-4 col-form-label">
                                <strong class="required-ast">Email Address</strong>
                            </div>
                            <div class="col-md-6">
                                <input class="form-control" required type="email" id="email" name="email" pattern="\b[\w\.-]+@[\w\.-]+\.\w{2,4}\b" placeholder="Please enter email" />
                                <p class="invalid-feedback">Email is required</p>
                                {% for error in form.email.errors %}
                                <div class="text-danger">{{error}}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <hr />
                        <div class="row form-group">
                            <div class="col-md-4 col-form-label">
                                <strong class="required-ast">First Name</strong>
                            </div>
                            <div class="col-md-6">
                                <input class="form-control" value="{{ form.first_name.value }}" required type="text" id="first-name" name="first_name" placeholder="Please enter your first name" />
                                <p class="invalid-feedback">First name is required</p>
                                {% for error in form.first_name.errors %}
                                <div class="text-danger">{{error}}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <hr />
                        <div class="row form-group">
                            <div class="col-md-4 col-form-label">
                                <strong class="required-ast">Last Name</strong>
                            </div>
                            <div class="col-md-6">
                                <input class="form-control" value="{{ form.last_name.value }}" required type="text" id="last-name" name="last_name" placeholder="Please enter your last name" />
                                <p class="invalid-feedback">Last name is required</p>
                                {% for error in form.last_name.errors %}
                                <div class="text-danger">{{error}}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <hr />
                        <div class="row form-group">
                            <div class="col-md-4 col-form-label">
                                <strong class="required-ast">IC Num/Passport</strong>
                            </div>
                            <div class="col-md-6">
                                <input class="form-control" value="{{ form.ic_passport.value }}" required type="text" id="ic-num-passport" name="ic_passport" placeholder="Plaese enter your IC number or passport number" />
                                <p class="invalid-feedback">IC num/passport is required</p>
                                {% for error in form.ic_passport.errors %}
                                <div class="text-danger">{{error}}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <hr />
                        <div class="row form-group">
                            <div class="col-md-4 col-form-label">
                                <strong class="required-ast">Phone Number</strong>
                            </div>
                            <div class="col-md-6">
                                <input class="form-control" value="{{ form.phone_num.value }}" required type="text" id="phone-number" name="phone_num" placeholder="Please enter your phone number" />
                                <p class="invalid-feedback">Phone number is required</p>
                                {% for error in form.phone_num.errors %}
                                <div class="text-danger">{{error}}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <hr />
                        <div class="row form-group">
                            <div class="col-md-4 col-form-label">
                                <strong class="required-ast">Gender</strong>
                            </div>
                            <div class="col-md-6">
                                <select class="form-control" id="gender" name="gender" required>
                                    {% for value, text in form.gender.field.choices %}
                                    <option value="{{value}}" {% if value == form.gender.value %} selected {% endif %} {% if value == "" %} disabled {% endif %}>
                                        {{text}}
                                    </option>
                                    {% endfor %}
                                </select>
                                <p class="invalid-feedback">Gender is required</p>
                                {% for error in form.gender.errors %}
                                <div class="text-danger">{{error}}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <hr />
                        <div class="row form-group">
                            <div class="col-md-4 col-form-label">
                                <strong class="required-ast">Date of Birth</strong>
                            </div>
                            <div class="col-md-6">
                                <input class="form-control" value="{{ form.dob.value }}" type="date" required id="dob" name="dob" />
                                <p class="invalid-feedback">Date of birth is required</p>
                                {% for error in form.dob.errors %}
                                <div class="text-danger">{{error}}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <hr />
                        <div class="row form-group">
                            <div class="col-md-4 col-form-label">
                                <strong class="required-ast">Nationality</strong>
                            </div>
                            <div class="col-md-6">
                                <select class="form-control" id="nationality" name="nationality" required>
                                    {% for value, text in form.nationality.field.choices %}
                                    <option value="{{value}}" {% if value == form.nationality.value %} selected {% endif %} {% if value == "" %} disabled {% endif %}>
                                        {{text}}
                                    </option>
                                    {% endfor %}
                                </select>
                                <p class="invalid-feedback">Nationality is required</p>
                                {% for error in form.nationality.errors %}
                                <div class="text-danger">{{error}}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <hr />
                        <div class="row form-group">
                            <div class="col-md-4 col-form-label">
                                <strong class="required-ast">Profile Picture</strong>
                            </div>
                            <div class="col-md-6">
                                <div class="custom-file">
                                    <input class="form-control custom-file-input" type="file" id="photo" name="photo" required value="{{form.photo.value}}" />
                                    <label class="custom-file-label" for="photo">Choose image</label>
                                    <p class="invalid-feedback">Profile picture is required</p>
                                    {% for error in form.photo.errors %}
                                    <div class="text-danger">{{error}}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card shadow-sm mt-3">
                    <div class="card-body">
                        <h5 class="font-weight-bold">Residential Address</h5>
                        <div class="row form-group">
                            <div class="col-md-4 col-form-label">
                                <strong class="required-ast">Address</strong>
                            </div>
                            <div class="col-md-6">
                                <input class="form-control" id="address" name="address" value="{{ form.address.value }}" required placeholder="Please enter your address" />
                                <p class="invalid-feedback">Address is required</p>
                                {% for error in form.address.errors %}
                                <div class="text-danger">{{error}}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <hr />
                        <div class="row form-group">
                            <div class="col-md-4 col-form-label">
                                <strong class="required-ast">Postcode</strong>
                            </div>
                            <div class="col-md-6">
                                <input class="form-control" id="postcode" name="postcode" value="{{ form.postcode.value }}" required placeholder="Please enter your postcode" />
                                <p class="invalid-feedback">Postcode is required</p>
                                {% for error in form.postcode.errors %}
                                <div class="text-danger">{{error}}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <hr />
                        <div class="row form-group">
                            <div class="col-md-4 col-form-label">
                                <strong class="required-ast">Country</strong>
                            </div>
                            <div class="col-md-6">
                                <select class="form-control" id="country" name="country" value="Malaysia" required>
                                    {% for value, text in form.country.field.choices %}
                                    <option value="{{value}}" {% if value == form.country.value %} selected {% endif %} {% if value == "" %} disabled {% endif %}>
                                        {{text}}
                                    </option>
                                    {% endfor %}
                                </select>
                                <p class="invalid-feedback">Country is required</p>
                                {% for error in form.country.errors %}
                                <div class="text-danger">{{error}}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <hr />
                        <div class="row form-group">
                            <div class="col-md-4 col-form-label">
                                <strong class="required-ast">State</strong>
                            </div>
                            <div class="col-md-6">
                                <select class="form-control" value="Johor" id="state" name="state" required>
                                    {% for value, text in form.state.field.choices %}
                                    <option value="{{value}}" {% if value == form.state.value %} selected {% endif %} {% if value == "" %} disabled {% endif %}>
                                        {{text}}
                                    </option>
                                    {% endfor %}
                                </select>
                                <p class="invalid-feedback">State is required</p>
                                {% for error in form.state.errors %}
                                <div class="text-danger">{{error}}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <hr />
                        <div class="row form-group">
                            <div class="col-md-4 col-form-label">
                                <strong class="required-ast">City</strong>
                            </div>
                            <div class="col-md-6">
                                <select class="form-control" id="city" name="city" required>
                                    {% for value, text in form.city.field.choices %}
                                    <option value="{{value}}" {% if value == form.city.value %} selected {% endif %} {% if value == "" %} disabled {% endif %}>
                                        {{text}}
                                    </option>
                                    {% endfor %}
                                </select>
                                <p class="invalid-feedback">City is required</p>
                                {% for error in form.city.errors %}
                                <div class="text-danger">{{error}}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card shadow-sm mt-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <h5 class="font-weight-bold">Action</h5>
                            </div>
                            <div class="col-6 text-right">
                                <button class="btn btn-outline-primary" type="button" id="save-btn">Save</button>
                                <a href="{% url 'patients' %}"><button class="btn btn-outline-warning" type="button">Cancel</button></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}
{% block script %}
<script>
    var statesCached = [];

    /*
    * Handle country select-option change
    */
    document.getElementById('country').addEventListener('change', (e) => {
        var val = e.target.value;
        getStates(val, (states) => {
            var stateOptions = '';
            statesCached = states;
            states.forEach(state => {
                stateOptions += `<option value="${state.id}">${state.state}</option>`;
            });
            document.getElementById('state').innerHTML = stateOptions;
            setCitiesOption(states[0].id)
        })
    });

    /*
    * Handle state select-option change
    */
    let setCitiesOption = (stateId) => {
        var cityOption = '';
        const state = statesCached.find((s) => s.id == stateId)
        state.cities.forEach((city) => {
            cityOption += `<option value="${city.city}">${city.city}</option>`;
        });
        document.getElementById('city').innerHTML = cityOption;

    }

    document.getElementById('state').addEventListener('change', (e) => {
        var val = e.target.value;



        if (statesCached.length < 1) {
            getStates(document.getElementById('country').value, (states) => {
                statesCached = states;
                setCitiesOption(val)
            });
        } else {
            setCitiesOption(val)
        }
    });

    /*
    * Handle form submission
    */
    document.getElementById("save-btn").addEventListener("click", (e) => {
        var form = document.getElementById('edit-profile-form');
        if (form.checkValidity()) {
            Swal.fire({
                title: "Confirmation to save profile",
                text: "Are you sure to save the patient?",
                icon: 'question',
                showCancelButton: true,

            }).then(({ isConfirmed }) => {
                if (isConfirmed) {
                    form.submit();
                }
            });
        }
        form.classList.add('was-validated');
    })

    var passwordVisibility = (elem) => {
        let state = {
            visible: false
        };

        let $elem = document.querySelector(elem);
        let $button = $elem.querySelector('button');
        let $passwordInput = $elem.querySelector("input");
        let $faIcon = $elem.querySelector('.fa-icon-password');

        $button.addEventListener('click', () => {
            if (!state.visible) {
                $passwordInput.type = 'text';
                $faIcon.classList.add('fa-eye-slash');
                $faIcon.classList.remove('fa-eye');
            }
            else {
                $passwordInput.type = 'password';
                $faIcon.classList.add('fa-eye');
                $faIcon.classList.remove('fa-eye-slash');
            }
            state.visible = !state.visible;
        });

        return $elem;
    }

    function getStates(iso2, callback) {
        $.ajax({
            url: `/api/states/${iso2}?format=json`,
            method: "GET",
            success: callback
        });
    }

    document.querySelector(".custom-file-input").addEventListener("change", (e) => {
        files = e.target.files;
        if (files.length > 0) {
            e.target.nextElementSibling.innerText = files[0].name;
        } else {
            e.target.nextElementSibling.innerText = 'Choose image';
        }
    })

    // document.getElementById('photo1').addEventListener('change', (e) => {
    //     console.log(e.target);
    //     var files = e.target.files;
    //     if (files && files.length) {
    //         var img = new Image();
    //         img.src = URL.createObjectURL(files[0]);
    //         img.onload = function () {
    //             console.log(img.width);
    //             console.log(img.height);
    //             var profile = document.getElementById('profile-img');
    //             profile.src = img.src;
    //             const width = img.width;
    //             const height = img.height;
    //             if(height>width){
    //                 const heightCal = height * 100 / width;
    //                 profile.style.width = '100px';
    //                 profile.style.height = heightCal;
    //                 profile.style.marginTop = -(heightCal - 100) / 2;
    //                 profile.style.marginLeft = 0;
    //             }else if(height<=width){
    //                 const widthCal = width * 100 / height;
    //                 profile.style.height = '100px';
    //                 profile.style.width = widthCal;
    //                 profile.style.marginLeft = -(widthCal - 100) / 2;
    //                 profile.style.marginTop = 0;
    //             }
    //         }
    //     }
    // });

</script>
{% endblock %}